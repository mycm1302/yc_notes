# Model Predictive Control (모델 예측 제어)

## 1. 개요 및 배경

Model Predictive Control (MPC)는 시스템의 미래 거동을 예측하여 현재의 최적 제어 입력을 계산하는 최적화 기반 제어 기법입니다. MPC는 1970년대 화학 공정 제어에서 시작되어, 현재는 로봇 제어를 포함한 다양한 분야에서 널리 사용되고 있습니다.

### 1.1 기본 원리

MPC의 핵심 아이디어는 다음과 같습니다:
1. **예측(Prediction)**: 현재 상태에서 시작하여 미래 N 스텝까지의 시스템 거동을 예측
2. **최적화(Optimization)**: 예측 구간에서 비용 함수를 최소화하는 제어 시퀀스 계산
3. **후퇴(Receding)**: 첫 번째 제어 입력만 적용하고, 다음 샘플링 시간에 전체 과정 반복

이러한 특성으로 인해 MPC는 "후퇴 지평선 제어(Receding Horizon Control)"라고도 불립니다.

### 1.2 로봇 제어에서의 필요성

로봇 매니퓰레이터 제어에서 MPC가 중요한 이유:
- **제약 조건 처리**: 관절 한계, 토크 한계, 장애물 회피 등을 체계적으로 처리
- **다목적 최적화**: 궤적 추종, 에너지 효율성, 안전성을 동시에 고려
- **예측 능력**: 미래 궤적을 미리 계산하여 선제적 제어 가능
- **비선형성 대응**: 비선형 MPC를 통해 로봇의 복잡한 동역학 직접 처리

### 1.3 역사적 발전

- **1970년대**: 화학 공정에서 DMC (Dynamic Matrix Control) 개발
- **1980년대**: GPC (Generalized Predictive Control) 등 다양한 MPC 변형 개발
- **1990년대**: 안정성 이론과 강인성 연구 발달
- **2000년대 이후**: 비선형 MPC와 로봇 응용 급속 발전

## 2. 수학적 기초

### 2.1 이산시간 시스템 모델

MPC는 일반적으로 다음과 같은 이산시간 상태공간 모델을 사용합니다:

$$x_{k+1} = f(x_k, u_k, d_k)$$
$$y_k = h(x_k)$$

여기서:
- $x_k \in \mathbb{R}^n$: 상태 벡터
- $u_k \in \mathbb{R}^m$: 제어 입력
- $d_k \in \mathbb{R}^p$: 외란
- $y_k \in \mathbb{R}^q$: 출력

선형 시스템의 경우:
$$x_{k+1} = A x_k + B u_k + E d_k$$
$$y_k = C x_k$$

### 2.2 MPC 최적화 문제

시간 k에서 MPC는 다음 최적화 문제를 해결합니다:

$$\min_{U_k} J_k = \sum_{i=0}^{N-1} \ell(x_{k+i|k}, u_{k+i|k}) + V_f(x_{k+N|k})$$

**제약 조건:**
- $x_{k+i+1|k} = f(x_{k+i|k}, u_{k+i|k})$, $i = 0, \ldots, N-1$
- $x_{k|k} = x_k$ (초기 조건)
- $u_{k+i|k} \in \mathcal{U}$, $i = 0, \ldots, N-1$ (입력 제약)
- $x_{k+i|k} \in \mathcal{X}$, $i = 1, \ldots, N$ (상태 제약)
- $x_{k+N|k} \in \mathcal{X}_f$ (종단 제약)

여기서:
- $N$: 예측 지평선 (prediction horizon)
- $\ell(\cdot, \cdot)$: 단계 비용 함수
- $V_f(\cdot)$: 종단 비용 함수
- $U_k = [u_{k|k}, u_{k+1|k}, \ldots, u_{k+N-1|k}]^T$: 제어 시퀀스

### 2.3 안정성 보장

MPC의 안정성을 보장하기 위한 주요 조건들:

1. **종단 제약**: $x_{k+N|k} \in \mathcal{X}_f$ (종단 영역 제약)
2. **종단 비용**: $V_f(x) = x^T P x$ (양정치 이차형식)
3. **제어 가능성**: $\mathcal{X}_f$ 내에서 안정화 제어기 존재

**안정성 정리**: 위 조건들이 만족되면, MPC 폐루프 시스템은 점근적으로 안정합니다.

### 2.4 비용 함수 설계

로봇 제어를 위한 일반적인 비용 함수:

$$\ell(x, u) = \|x - x_{ref}\|_Q^2 + \|u - u_{ref}\|_R^2 + \|u - u_{k-1}\|_S^2$$

여기서:
- Q: 상태 가중 행렬 (추적 성능)
- R: 입력 가중 행렬 (에너지 효율성)
- S: 입력 변화 가중 행렬 (부드러운 제어)

### 2.5 제약 조건 처리

MPC의 주요 장점 중 하나는 제약 조건의 체계적 처리입니다:

**상태 제약**:
- 관절 위치 한계: $q_{min} \leq q \leq q_{max}$
- 관절 속도 한계: $\dot{q}_{min} \leq \dot{q} \leq \dot{q}_{max}$

**입력 제약**:
- 토크 한계: $\tau_{min} \leq \tau \leq \tau_{max}$
- 토크 변화율 한계: $|\Delta\tau| \leq \Delta\tau_{max}$

**안전 제약**:
- 장애물 회피: $\|p_{ee} - p_{obs}\| \geq d_{safe}$
- 특이점 회피: $\det(J(q)) \geq \epsilon$

### 2.6 비선형 MPC (NMPC)

로봇의 비선형 동역학을 직접 다루는 NMPC:

$$\min_{U_k} \sum_{i=0}^{N-1} \ell(x_{k+i|k}, u_{k+i|k}) + V_f(x_{k+N|k})$$

**제약 조건:**
$$x_{k+i+1|k} = f(x_{k+i|k}, u_{k+i|k})$$

여기서 f(·,·)는 로봇의 비선형 동역학 모델입니다.
