# Model Predictive Control (모델 예측 제어)

## 1. 개요 및 배경

Model Predictive Control (MPC)는 시스템의 미래 거동을 예측하여 현재의 최적 제어 입력을 계산하는 최적화 기반 제어 기법입니다. MPC는 1970년대 화학 공정 제어에서 시작되어, 현재는 로봇 제어를 포함한 다양한 분야에서 널리 사용되고 있습니다.

### 1.1 기본 원리

MPC의 핵심 아이디어는 다음과 같습니다:
1. **예측(Prediction)**: 현재 상태에서 시작하여 미래 N 스텝까지의 시스템 거동을 예측
2. **최적화(Optimization)**: 예측 구간에서 비용 함수를 최소화하는 제어 시퀀스 계산
3. **후퇴(Receding)**: 첫 번째 제어 입력만 적용하고, 다음 샘플링 시간에 전체 과정 반복

이러한 특성으로 인해 MPC는 "후퇴 지평선 제어(Receding Horizon Control)"라고도 불립니다.

### 1.2 로봇 제어에서의 필요성

로봇 매니퓰레이터 제어에서 MPC가 중요한 이유:
- **제약 조건 처리**: 관절 한계, 토크 한계, 장애물 회피 등을 체계적으로 처리
- **다목적 최적화**: 궤적 추종, 에너지 효율성, 안전성을 동시에 고려
- **예측 능력**: 미래 궤적을 미리 계산하여 선제적 제어 가능
- **비선형성 대응**: 비선형 MPC를 통해 로봇의 복잡한 동역학 직접 처리

### 1.3 역사적 발전

- **1970년대**: 화학 공정에서 DMC (Dynamic Matrix Control) 개발
- **1980년대**: GPC (Generalized Predictive Control) 등 다양한 MPC 변형 개발
- **1990년대**: 안정성 이론과 강인성 연구 발달
- **2000년대 이후**: 비선형 MPC와 로봇 응용 급속 발전

## 2. 수학적 기초

### 2.1 이산시간 시스템 모델

MPC는 일반적으로 다음과 같은 이산시간 상태공간 모델을 사용합니다:

$$x_{k+1} = f(x_k, u_k, d_k)$$
$$y_k = h(x_k)$$

여기서:
- $x_k \in \mathbb{R}^n$: 상태 벡터
- $u_k \in \mathbb{R}^m$: 제어 입력
- $d_k \in \mathbb{R}^p$: 외란
- $y_k \in \mathbb{R}^q$: 출력

선형 시스템의 경우:
$$x_{k+1} = A x_k + B u_k + E d_k$$
$$y_k = C x_k$$

### 2.2 MPC 최적화 문제

시간 k에서 MPC는 다음 최적화 문제를 해결합니다:

$$\min_{U_k} J_k = \sum_{i=0}^{N-1} \ell(x_{k+i|k}, u_{k+i|k}) + V_f(x_{k+N|k})$$

**제약 조건:**
- $x_{k+i+1|k} = f(x_{k+i|k}, u_{k+i|k})$, $i = 0, \ldots, N-1$
- $x_{k|k} = x_k$ (초기 조건)
- $u_{k+i|k} \in \mathcal{U}$, $i = 0, \ldots, N-1$ (입력 제약)
- $x_{k+i|k} \in \mathcal{X}$, $i = 1, \ldots, N$ (상태 제약)
- $x_{k+N|k} \in \mathcal{X}_f$ (종단 제약)

여기서:
- $N$: 예측 지평선 (prediction horizon)
- $\ell(\cdot, \cdot)$: 단계 비용 함수
- $V_f(\cdot)$: 종단 비용 함수
- $U_k = [u_{k|k}, u_{k+1|k}, \ldots, u_{k+N-1|k}]^T$: 제어 시퀀스

### 2.3 안정성 보장

MPC의 안정성을 보장하기 위한 주요 조건들:

1. **종단 제약**: $x_{k+N|k} \in \mathcal{X}_f$ (종단 영역 제약)
2. **종단 비용**: $V_f(x) = x^T P x$ (양정치 이차형식)
3. **제어 가능성**: $\mathcal{X}_f$ 내에서 안정화 제어기 존재

**안정성 정리**: 위 조건들이 만족되면, MPC 폐루프 시스템은 점근적으로 안정합니다.

### 2.4 비용 함수 설계

로봇 제어를 위한 일반적인 비용 함수:

$$\ell(x, u) = \|x - x_{ref}\|_Q^2 + \|u - u_{ref}\|_R^2 + \|u - u_{k-1}\|_S^2$$

여기서:
- Q: 상태 가중 행렬 (추적 성능)
- R: 입력 가중 행렬 (에너지 효율성)
- S: 입력 변화 가중 행렬 (부드러운 제어)

### 2.5 제약 조건 처리

MPC의 주요 장점 중 하나는 제약 조건의 체계적 처리입니다:

**상태 제약**:
- 관절 위치 한계: $q_{min} \leq q \leq q_{max}$
- 관절 속도 한계: $\dot{q}_{min} \leq \dot{q} \leq \dot{q}_{max}$

**입력 제약**:
- 토크 한계: $\tau_{min} \leq \tau \leq \tau_{max}$
- 토크 변화율 한계: $|\Delta\tau| \leq \Delta\tau_{max}$

**안전 제약**:
- 장애물 회피: $\|p_{ee} - p_{obs}\| \geq d_{safe}$
- 특이점 회피: $\det(J(q)) \geq \epsilon$

### 2.6 비선형 MPC (NMPC)

로봇의 비선형 동역학을 직접 다루는 NMPC:

$$\min_{U_k} \sum_{i=0}^{N-1} \ell(x_{k+i|k}, u_{k+i|k}) + V_f(x_{k+N|k})$$

**제약 조건:**
$$x_{k+i+1|k} = f(x_{k+i|k}, u_{k+i|k})$$

여기서 f(·,·)는 로봇의 비선형 동역학 모델입니다.

## 3. 로봇 제어 적용

### 3.1 로봇 매니퓰레이터 동역학 모델

n자유도 로봇 매니퓰레이터의 연속시간 동역학:

$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$

이를 상태공간 형태로 표현하면:
$$\dot{x} = \begin{bmatrix} \dot{q} \\ M(q)^{-1}[\tau - C(q,\dot{q})\dot{q} - G(q)] \end{bmatrix}$$

여기서 $x = [q^T, \dot{q}^T]^T$입니다.

### 3.2 이산화 및 선형화

**오일러 방법에 의한 이산화**:
$$x_{k+1} = x_k + h \cdot f(x_k, u_k)$$

**작동점에서의 선형화**:
$$x_{k+1} = A_k x_k + B_k u_k + c_k$$

여기서:
- $A_k = I + h \frac{\partial f}{\partial x}\big|_{x_k, u_k}$
- $B_k = h \frac{\partial f}{\partial u}\big|_{x_k, u_k}$

### 3.3 궤적 추종 MPC

기준 궤적 $q_{ref}(t)$를 추종하는 MPC 설계:

**비용 함수**:
$$J = \sum_{i=0}^{N-1} [\|q_{k+i|k} - q_{ref,k+i}\|_Q^2 + \|\tau_{k+i|k}\|_R^2] + \|q_{k+N|k} - q_{ref,k+N}\|_P^2$$

**제약 조건**:
- 동역학: $x_{k+i+1|k} = f(x_{k+i|k}, \tau_{k+i|k})$
- 관절 한계: $q_{min} \leq q_{k+i|k} \leq q_{max}$
- 속도 한계: $\dot{q}_{min} \leq \dot{q}_{k+i|k} \leq \dot{q}_{max}$
- 토크 한계: $\tau_{min} \leq \tau_{k+i|k} \leq \tau_{max}$

### 3.4 장애물 회피 MPC

엔드 이펙터의 장애물 회피를 포함한 MPC:

**추가 제약**:
$$\|p_{ee}(q_{k+i|k}) - p_{obs,j}\| \geq d_{safe,j}, \quad j = 1, \ldots, N_{obs}$$

여기서:
- $p_{ee}(q)$: 엔드 이펙터 위치 (순기구학)
- $p_{obs,j}$: j번째 장애물 위치
- $d_{safe,j}$: j번째 장애물과의 안전 거리

### 3.5 모바일 매니퓰레이터 MPC

모바일 베이스를 가진 로봇의 통합 제어:

**확장된 상태**:
$$x = [x_b, y_b, \theta_b, q_1, \ldots, q_n, \dot{x}_b, \dot{y}_b, \dot{\theta}_b, \dot{q}_1, \ldots, \dot{q}_n]^T$$

**제어 입력**:
$$u = [v_x, v_y, \omega, \tau_1, \ldots, \tau_n]^T$$

**전체 시스템 동역학**:
베이스와 매니퓰레이터의 결합 동역학을 고려한 복합 모델 사용

## 4. 적응형 및 강인 MPC

### 4.1 적응형 MPC

시스템 매개변수의 불확실성에 대응하는 적응형 MPC:

**매개변수 추정**:
$$\hat{\theta}_{k+1} = \hat{\theta}_k + \gamma \Phi_k^T (y_k - \Phi_k \hat{\theta}_k)$$

여기서:
- $\hat{\theta}_k$: 추정된 매개변수
- $\Phi_k$: 회귀 벡터
- $\gamma$: 적응 이득

**Guay, Adetola, DeHaan의 접근법**:
집합 기반 매개변수 추정을 통한 강인 적응 MPC

### 4.2 강인 MPC

불확실성이 있는 시스템을 위한 강인 MPC:

**시나리오 기반 접근법**:
$$\min_{U_k} \max_{w \in \mathcal{W}} J_k(U_k, w)$$

**튜브 기반 MPC**:
명목 궤적 주변의 불변 집합을 이용한 강인성 보장

### 4.3 학습 기반 MPC

데이터를 활용한 모델 개선:

**Gaussian Process MPC**:
GP를 이용한 모델 불확실성 학습 및 보상

**신경망 MPC**:
심층 학습을 통한 동역학 모델 학습

## 5. 장단점 분석

### 5.1 장점

1. **제약 조건 처리**: 물리적 제약을 체계적이고 자연스럽게 처리
2. **다목적 최적화**: 여러 성능 지표를 동시에 고려 가능
3. **예측 능력**: 미래 거동 예측을 통한 선제적 제어
4. **MIMO 시스템**: 다입력 다출력 시스템에 자연스럽게 적용
5. **비선형성 대응**: NMPC를 통한 직접적인 비선형 시스템 제어
6. **온라인 최적화**: 실시간으로 최적 제어 계산

### 5.2 단점

1. **계산 복잡성**: 실시간 최적화로 인한 높은 계산 부담
2. **모델 의존성**: 정확한 예측 모델이 필요
3. **튜닝 복잡성**: 다양한 가중 행렬과 매개변수 조정 필요
4. **지역 최적해**: 비선형 MPC에서 지역 최적해에 수렴 가능성
5. **안정성 보장**: 제한된 조건에서만 안정성 보장

## 6. 최신 동향

### 6.1 분산 MPC
대규모 로봇 시스템을 위한 분산 제어 아키텍처

### 6.2 학습 강화 MPC
강화학습과 MPC의 결합을 통한 성능 향상

### 6.3 고속 최적화 알고리즘
실시간 구현을 위한 빠른 최적화 솔버 개발

### 6.4 경제적 MPC (EMPC)
에너지 효율성을 고려한 경제적 목적 함수 설계

## 7. 관련 텍스트북 및 참고문헌

### 주요 텍스트북

1. **Rawlings, J. B., Mayne, D. Q., & Diehl, M. (2017)**. "Model Predictive Control: Theory, Computation, and Design" (2nd Edition). Nob Hill Publishing.
   - MPC의 가장 포괄적인 텍스트북
   - 이론부터 실제 구현까지 상세히 다룸

2. **Kouvaritakis, B., & Cannon, M. (2016)**. "Model Predictive Control: Classical, Robust and Stochastic". Springer.
   - 고전적, 강인, 확률적 MPC를 포괄적으로 다룸

3. **Guay, M., Adetola, V., & DeHaan, D. (2015)**. "Robust and Adaptive Model Predictive Control of Nonlinear Systems". IET.
   - 비선형 시스템의 강인 적응 MPC 전문서

### 로봇 응용 참고문헌
- Verscheure, D., et al. (2009). "Time-optimal path tracking for robots: A convex optimization approach". IEEE Transactions on Automatic Control.
- Kleff, S., et al. (2021). "High-frequency nonlinear model predictive control of a manipulator". ICRA.
- Neunert, M., et al. (2018). "Whole-body nonlinear model predictive control through contacts for humanoids". IEEE-RAS International Conference on Humanoid Robots.

이 문서는 Rawlings, Mayne, Diehl의 "Model Predictive Control: Theory, Computation, and Design"와 관련 최신 연구를 주요 참고문헌으로 하여 작성되었습니다.
