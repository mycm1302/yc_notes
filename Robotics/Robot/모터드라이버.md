# 모터드라이버

> 상위: [[전자회로설계]]

로봇 구동을 위한 직류 모터 제어 회로와 드라이버 설계입니다.

## ⚙️ BLDC 모터 제어

### 브러시리스 영구자석 직류 모터 특징
- **고효율**: 90% 이상의 효율
- **정밀 제어**: 홀 센서 또는 엔코더 피드백
- **긴 수명**: 브러시 마모 없음
- **저소음**: 기계적 접촉 최소화

### 모터 선정 기준
```
토크 = 부하 관성 × 각가속도 + 마찰 토크

필요 스펙 예시:
- 정격 토크: 0.5 Nm
- 최대 속도: 3000 RPM
- 정격 전압: 24V  
- 정격 전류: 2A
```

## 🔌 3상 인버터 회로

### MOSFET 브리지
```
DC+ ─┬─ Q1 ─┬─ U상
     ├─ Q3 ─┼─ V상
     └─ Q5 ─┼─ W상
            │
DC- ─┴─ Q2,Q4,Q6 ─┘
```
### MOSFET 선정
```
주요 파라미터:
- Rds(on): 온 저항 (낮을수록 효율 좋음)
- Id: 드레인 전류 (모터 전류의 1.5배 이상)
- Vds: 내압 (전원 전압의 2배 이상)

추천 MOSFET:
- 저전력: IRF530N, IRLZ44N
- 고전력: IRF3205, IRFP260N
```

## 📊 PWM 제어

### ESP32 3상 PWM 생성
```cpp
void setupMotorPWM() {
    // 20kHz PWM 설정
    ledcSetup(0, 20000, 8);  // 채널0, 20kHz, 8bit
    ledcSetup(1, 20000, 8);  // 채널1
    ledcSetup(2, 20000, 8);  // 채널2
    
    // 핀 연결
    ledcAttachPin(12, 0);  // U상
    ledcAttachPin(13, 1);  // V상
    ledcAttachPin(14, 2);  // W상
}

void setMotorVoltage(float u, float v, float w) {
    ledcWrite(0, (int)(u * 255));
    ledcWrite(1, (int)(v * 255));  
    ledcWrite(2, (int)(w * 255));
}
```
### PID 제어기 구현
```cpp
class PIDController {
private:
    float kp, ki, kd;
    float prev_error = 0;
    float integral = 0;
    
public:
    float update(float setpoint, float feedback, float dt) {
        float error = setpoint - feedback;
        float p_term = kp * error;
        integral += error * dt;
        float i_term = ki * integral;
        float derivative = (error - prev_error) / dt;
        float d_term = kd * derivative;
        prev_error = error;
        return p_term + i_term + d_term;
    }
};
```

## 🛡️ 보호 기능

### 과전류 보호
```cpp
// 홀 센서 기반 전류 측정 (ACS712)
float readMotorCurrent() {
    int adc_value = analogRead(CURRENT_SENSOR_PIN);
    float voltage = adc_value * 3.3 / 4095.0;
    float current = (voltage - 1.65) / 0.066;
    return current;
}

void checkOvercurrent() {
    if(readMotorCurrent() > MAX_CURRENT) {
        emergencyStop();
    }
}
```

### 비상 정지
```cpp
void emergencyStop() {
    ledcWrite(0, 0);  // 모든 PWM 출력 0
    ledcWrite(1, 0);
    ledcWrite(2, 0);
    digitalWrite(BRAKE_PIN, HIGH);  // 브레이크 활성화
}
```

---

## 🔗 연결 문서
- 상위: [[전자회로설계]]
- 관련: [[전원시스템]], [[PWM신호생성]]
- 응용: [[직류모터]], [[엔코더]]