# 전신제어기법 (Whole Body Control, WBC)

> 상위: [[고급제어]]

## 1. 개요 및 배경

전신제어기법(Whole Body Control, WBC)은 휴머노이드 로봇과 같은 복잡한 다관절 시스템에서 여러 작업을 동시에 수행하면서도 물리적 제약조건을 만족하는 통합된 제어 프레임워크입니다. [IEEE Robotics and Automation Society의 WBC Technical Committee](https://www.ieee-ras.org/whole-body-control)에 의하면, WBC는 로봇의 전체 자유도를 활용하여 다중 작업을 동시에 실행할 수 있는 일반화된 제어 시스템을 의미합니다.

### 1.1 기본 개념

WBC의 핵심 아이디어:
1. **작업 우선순위**: 여러 제어 목표 간의 계층적 우선순위 설정
2. **제약조건 만족**: 관절 한계, 접촉 제약, 동적 평형 등 물리적 제약 준수
3. **전신 활용**: 로봇의 모든 자유도를 효율적으로 활용
4. **실시간 성능**: 복잡한 최적화 문제의 실시간 해결

### 1.2 기존 제어와의 차이점

**전통적 제어 방식**:
- 단일 작업에 특화된 제어기
- 관절별 독립적 제어
- 제약조건의 사후 처리

**WBC 방식**:
- 다중 작업의 동시 실행
- 전신 통합 제어
- 제약조건의 사전 고려

### 1.3 응용 분야

- **휴머노이드 로봇**: 보행과 조작의 동시 실행
- **모바일 매니퓰레이터**: 베이스와 매니퓰레이터의 협조 제어
- **사족 로봇**: 이동과 조작의 통합
- **우주 로봇**: 자유부유 상태에서의 조작

## 2. 수학적 기초

### 2.1 운동 방정식

부유 베이스 로봇의 동역학은 다음과 같이 표현됩니다:

$$\mathbf{M}(\mathbf{q})\ddot{\mathbf{q}} + \mathbf{C}(\mathbf{q},\dot{\mathbf{q}})\dot{\mathbf{q}} + \mathbf{G}(\mathbf{q}) = \mathbf{S}^T\boldsymbol{\tau} + \sum_{i} \mathbf{J}_i^T(\mathbf{q})\mathbf{F}_i$$

여기서:
- **q** = [**q**ᵦ, **q**ⱼ]ᵀ: 베이스와 관절 좌표
- **M**(q): 관성 행렬
- **C**(q,q̇): 코리올리 및 원심력 행렬
- **G**(q): 중력 벡터
- **S**: 액추에이터 선택 행렬
- **Jᵢ**: i번째 접촉점의 자코비안
- **Fᵢ**: i번째 접촉력

### 2.2 작업 공간 정의

**운영 공간 좌표** (Khatib, 1987):
$$\mathbf{x} = \mathbf{f}(\mathbf{q})$$

**자코비안 관계**:
$$\dot{\mathbf{x}} = \mathbf{J}(\mathbf{q})\dot{\mathbf{q}}$$
$$\ddot{\mathbf{x}} = \mathbf{J}(\mathbf{q})\ddot{\mathbf{q}} + \dot{\mathbf{J}}(\mathbf{q},\dot{\mathbf{q}})\dot{\mathbf{q}}$$

### 2.3 계층적 작업 구조

**작업 우선순위**:
1. **제약조건** (최고 우선순위): 관절 한계, 접촉 제약
2. **운영 작업**: 말단장치 위치/자세 제어
3. **자세 제어**: 나머지 자유도의 자세 최적화

**계층적 투영**:
$$\mathbf{J}_1^{\#} = \mathbf{J}_1^T(\mathbf{J}_1\mathbf{M}^{-1}\mathbf{J}_1^T)^{-1}\mathbf{M}^{-1}$$
$$\mathbf{N}_1 = \mathbf{I} - \mathbf{J}_1^{\#}\mathbf{J}_1$$
$$\mathbf{J}_{2|1} = \mathbf{J}_2\mathbf{N}_1$$

## 3. 제어 방법론

### 3.1 계층적 이차계획법 (Hierarchical QP)

**문제 정식화** (Sentis & Khatib, 2005):

```
최고 우선순위:
minimize     ||Jₓ₁q̈ - ẍ₁*||²
subject to   Aq̈ ≤ b (접촉 및 관절 제약)

두 번째 우선순위:
minimize     ||Jₓ₂q̈ - ẍ₂*||²
subject to   Aq̈ ≤ b
             Jₓ₁q̈ = ẍ₁* (첫 번째 작업 해 고정)

세 번째 우선순위:
minimize     ||Jₓ₃q̈ - ẍ₃*||²
subject to   이전 제약들 + 이전 작업 해들 고정
```

### 3.2 가중 이차계획법 (Weighted QP)

**통합 최적화** (TSID 방식):
$$\min_{\ddot{\mathbf{q}}, \mathbf{F}} \sum_{i} w_i \|\mathbf{J}_i \ddot{\mathbf{q}} - \ddot{\mathbf{x}}_i^*\|^2$$

subject to:
- **M**q̈ + **h** = **S**ᵀτ + **J**ᶜᵀ**F**
- **A**q̈ ≤ **b** (관절 한계)
- **F** ∈ ℱ (마찰 원뿔 제약)

### 3.3 영공간 투영 방법

**Khatib의 운영공간 제어** (1987):
$$\boldsymbol{\tau} = \mathbf{J}^T\mathbf{F}_{\text{task}} + (\mathbf{I} - \mathbf{J}^T\mathbf{J}^{\#T})\boldsymbol{\tau}_{\text{posture}}$$

여기서:
- **J**ᵗ: 일관성 있는 동적 역산 자코비안
- **F**ₜₐₛₖ: 작업 공간 제어력
- **τ**ₚₒₛₜᵤᵣₑ: 자세 제어 토크

## 4. 안정성 분석

### 4.1 운동량 기반 접근법

**전체 운동량 보존**:
$$\mathbf{L} = \mathbf{A}_G(\mathbf{q})\dot{\mathbf{q}}$$

여기서 **A**_G는 중심질량 운동량 행렬입니다.

**운동량 변화율**:
$$\dot{\mathbf{L}} = \sum_{i} \mathbf{F}_i$$

### 4.2 영점 운동량 점 (ZMP)

**ZMP 조건**:
$$\mathbf{p}_{\text{ZMP}} = \mathbf{p}_{\text{CoM}} - \frac{z_{\text{CoM}}}{m g} \ddot{\mathbf{p}}_{\text{CoM}}$$

**안정성 조건**: ZMP가 지지 다각형 내부에 위치

### 4.3 캡쳐 포인트 (Capture Point)

**순간 캡쳐 포인트**:
$$\mathbf{p}_{\text{CP}} = \mathbf{p}_{\text{CoM}} + \frac{1}{\omega_0}\dot{\mathbf{p}}_{\text{CoM}}$$

여기서 ω₀ = √(g/z_CoM)는 고유 주파수입니다.

## 5. 실제 응용

### 5.1 휴머노이드 보행 제어

**다중 작업 구조**:
1. **ZMP 제약** (최고 우선순위)
2. **스윙발 궤적** (두 번째 우선순위)  
3. **상체 자세** (세 번째 우선순위)
4. **관절 중심 위치** (최저 우선순위)

### 5.2 로코매니퓰레이션 (Loco-manipulation)

**보행과 조작의 통합**:
- 베이스 이동으로 작업공간 확장
- 팔과 다리의 협조적 제어
- 동적 평형 유지하면서 정밀 조작

### 5.3 다중 접촉 제어

**접촉력 분배**:
$$\min_{\mathbf{F}_1, \ldots, \mathbf{F}_n} \|\mathbf{W}(\mathbf{F}_1 + \cdots + \mathbf{F}_n - \mathbf{F}_{\text{desired}})\|^2$$

subject to:
- 마찰 원뿔 제약: **F**ᵢ ∈ ℱᵢ
- 접촉력 비음 조건

## 6. 구현 고려사항

### 6.1 실시간 QP 해결

**고속 QP 솔버**:
- **qpOASES**: 활성 집합 방법
- **OSQP**: ADMM 기반 방법
- **Gurobi**: 상용 고성능 솔버
- **사용자 정의 솔버**: 구조 특화 최적화

**계산 복잡도**: O(n³) → O(n) (구조 활용시)

### 6.2 센서 요구사항

**필수 센서**:
- **IMU**: 베이스 자세 및 각속도
- **관절 엔코더**: 관절 위치 및 속도
- **힘/토크 센서**: 접촉력 측정 (선택)

**센서 융합**: 상태 추정을 위한 확장 칼만 필터

### 6.3 모델 정확도

**중요 매개변수**:
- 링크 질량 및 관성
- 기구학적 매개변수
- 접촉 모델 (강성, 댐핑)

**모델 오차의 영향**: 성능 저하 및 불안정성

## 7. 소프트웨어 프레임워크

### 7.1 오픈소스 라이브러리

- **DART**: 동역학 시뮬레이션 및 제어
- **Pinocchio**: 고속 강체 동역학 라이브러리
- **RigidBodyDynamics**: C++ 동역학 라이브러리
- **Drake**: 조작 계획 및 제어 도구상자

### 7.2 전용 WBC 프레임워크

- **ControlIt!** (Sentis 그룹): ROS 기반 WBC 프레임워크
- **TSID** (Bauzil 등): 작업공간 역동역학
- **mc_rtc**: 멀티 컨택트 제어 프레임워크

## 8. 변형과 확장

### 8.1 모델 예측 제어 (MPC) 통합

**예측 기반 WBC**:
- 미래 상태 예측
- 최적 제어 시퀀스 계획
- 제약조건의 예측적 처리

### 8.2 기계학습과의 결합

**학습 기반 접근법**:
- 강화학습으로 작업 우선순위 학습
- 신경망 기반 모델 보정
- 시연 학습을 통한 정책 획득

### 8.3 적응형 제어

**온라인 적응**:
- 매개변수 추정
- 환경 변화 대응
- 고장 허용 제어

## 9. 장단점 분석

### 9.1 장점

1. **통합성**: 다중 작업의 체계적 통합
2. **유연성**: 다양한 로봇 플랫폼 적용 가능
3. **확장성**: 새로운 작업의 쉬운 추가
4. **이론적 기반**: 견고한 수학적 기초
5. **실시간 성능**: 최적화된 구현으로 실시간 실행

### 9.2 단점

1. **계산 복잡성**: 높은 계산 부하
2. **모델 의존성**: 정확한 동역학 모델 필요
3. **튜닝 복잡성**: 다중 매개변수 조정 필요
4. **센서 요구**: 다수의 고정밀 센서 필요
5. **안정성 보장**: 모든 상황에서의 안정성 어려움

## 10. 최신 동향

### 10.1 딥러닝과의 융합

- **신경망 기반 WBC**: 학습된 역동역학 모델
- **엔드투엔드 학습**: 센서에서 제어까지 통합 학습
- **시뮬레이션 투 리얼**: 시뮬레이션에서 학습한 정책의 실제 적용

### 10.2 클라우드 로보틱스

- **분산 WBC**: 클라우드 기반 최적화
- **디지털 트윈**: 실제 로봇과 가상 모델 연동
- **협업 로봇**: 다수 로봇의 WBC 협조

### 10.3 인간-로봇 협업

- **공유 제어**: 인간과 로봇의 협조적 제어
- **의도 추정**: 인간 의도 예측 및 반영
- **안전성 강화**: 인간 근접 환경에서의 안전 보장

## 11. 관련 텍스트북 및 참고문헌

### 주요 텍스트북

1. **Lynch, K. M., & Park, F. C. (2017)**. "Modern Robotics: Mechanics, Planning, and Control". Cambridge University Press.
   - 나사 이론 기반의 현대적 로봇공학
   - WBC의 수학적 기초 제공
   - [무료 PDF](https://hades.mech.northwestern.edu/index.php/Modern_Robotics) 및 Coursera 강의 제공

2. **Siciliano, B., & Khatib, O. (Eds.) (2016)**. "Springer Handbook of Robotics" (2nd Edition). Springer.
   - WBC 관련 포괄적 리뷰 포함
   - Operational Space 이론의 최신 발전

3. **Featherstone, R. (2008)**. "Rigid Body Dynamics Algorithms". Springer.
   - 고속 동역학 알고리즘
   - WBC 구현의 핵심 기술

### 중요 논문들

1. **Khatib, O. (1987)**. "A Unified Approach for Motion and Force Control of Robot Manipulators: The Operational Space Formulation". IEEE Journal on Robotics and Automation.
   - WBC의 이론적 기초
   - [원문 PDF](https://khatib.stanford.edu/publications/pdfs/Khatib_1987_RA.pdf)

2. **Sentis, L., & Khatib, O. (2005)**. "Synthesis of Whole-Body Behaviors through Hierarchical Control of Behavioral Primitives". International Journal of Humanoid Robotics.
   - 계층적 WBC의 정립
   - 휴머노이드 적용 사례

3. **Moro, F. L. (2018)**. "Whole-Body Control of Humanoid Robots". In Springer Handbook of Robotics.
   - WBC의 최신 동향 및 응용
   - 실제 구현 고려사항

4. **Koolen, T., et al. (2016)**. "Design of a Momentum-Based Control Framework and Application to the Humanoid Robot Atlas". International Journal of Humanoid Robotics.
   - 운동량 기반 WBC 실제 적용
   - DARPA Robotics Challenge 경험

### 최신 연구 동향

- **Carpentier, J., et al. (2019)**. "The Pinocchio C++ Library: A Fast and Flexible Implementation of Rigid Body Dynamics Algorithms and their Analytical Derivatives". SII.
- **Tonneau, S., et al. (2018)**. "An Efficient Acyclic Contact Planner for Multiped Robots". IEEE Transactions on Robotics.
- **Wensing, P. M., et al. (2018)**. "Optimization-Based Full Body Control for the DARPA Robotics Challenge". Journal of Field Robotics.

### IEEE RAS 전신제어 기술위원회

- **공식 정의 및 동향**: [IEEE RAS WBC Technical Committee](https://www.ieee-ras.org/whole-body-control)
- 전신제어의 표준화 및 벤치마킹 주도

이 문서는 Khatib의 운영공간 이론, Sentis & Khatib의 계층적 제어 논문, 그리고 Lynch & Park의 "Modern Robotics"를 주요 참고문헌으로 하여 작성되었습니다.