# 마이크로컨트롤러

> 상위: [[전자회로설계]]

ESP32를 중심으로 한 로봇 제어 시스템의 마이크로컨트롤러 설계입니다.

## 🎯 ESP32 센서 데이터 관리

### ESP32 선택 이유  
- **듀얼 코어**: 240MHz Xtensa LX6
- **내장 WiFi/Bluetooth**: 무선 통신 지원
- **풍부한 인터페이스**: GPIO, I2C, SPI, UART, ADC
- **개발 생태계**: Arduino IDE, ESP-IDF 지원

### 핀 배치 계획
```
센서 인터페이스:
- I2C: GPIO21(SDA), GPIO22(SCL) - IMU, 압력센서
- SPI: GPIO18(SCK), GPIO19(MISO), GPIO23(MOSI)
- ADC: GPIO32-39 - 아날로그 센서 (로드셀)
- 인터럽트: GPIO2, GPIO4 - 엔코더, 리미트 스위치

모터 제어:
- PWM: GPIO12-15 - 모터 속도 제어
- 디지털 출력: GPIO25-27 - 방향 제어

통신:
- UART: GPIO16(RX), GPIO17(TX) - 외부 통신  
- CAN: GPIO5(TX), GPIO35(RX) - CAN 트랜시버
```
## 🔌 주변 회로 설계

### 전원 공급 회로
```
5V 입력 → AMS1117-3.3V → ESP32 (3.3V)
                    ↓
            100μF + 100nF 디커플링
```

### 리셋 및 부트 회로
```
RESET: 10kΩ Pull-up + 버튼 + 100nF 디바운스
BOOT: 10kΩ Pull-up + 버튼 (프로그래밍용)
EN: 10kΩ Pull-up (활성화)
```

## 🔧 센서 데이터 관리 구조

### 실시간 데이터 수집
```cpp
// FreeRTOS 태스크 기반 구조
xTaskCreatePinnedToCore(
    sensorTask,     // 센서 데이터 수집
    "SensorTask", 
    4096,           // 스택 크기
    NULL, 
    2,              // 우선순위
    NULL,
    0               // 코어 0
);

xTaskCreatePinnedToCore(
    controlTask,    // 제어 로직
    "ControlTask",
    8192,
    NULL,
    3,              // 높은 우선순위  
    NULL,
    1               // 코어 1
);
```
### 데이터 구조체
```cpp
typedef struct {
    float accel[3];     // 가속도 X, Y, Z
    float gyro[3];      // 각속도 X, Y, Z  
    float angle;        // 엔코더 각도
    float force;        // 로드셀 힘
    uint32_t timestamp; // 타임스탬프
} SensorData_t;

QueueHandle_t sensorQueue;  // 센서 데이터 큐
```

### 필터링 구현
```cpp
// 이동평균 필터
class MovingAverage {
private:
    float buffer[FILTER_SIZE];
    int index = 0;
    float sum = 0;
    
public:
    float update(float value) {
        sum -= buffer[index];
        buffer[index] = value;
        sum += value;
        index = (index + 1) % FILTER_SIZE;
        return sum / FILTER_SIZE;
    }
};
```

## 🚨 안전 및 예외처리

### 센서 오류 처리
```cpp
bool readSensorSafe(SensorData_t *data) {
    const int MAX_RETRIES = 3;
    
    for(int retry = 0; retry < MAX_RETRIES; retry++) {
        if(readSensor(data)) {
            return true;  // 성공
        }
        delay(10);  // 재시도 대기
    }
    
    setSafeValues(data);  // 안전 값 설정
    return false;
}
```

---

## 🔗 연결 문서
- 상위: [[전자회로설계]]
- 관련: [[마이크로프로세서]], [[센서인터페이스]]
- 응용: [[실시간제어]], [[통신인터페이스]], [[모터드라이버]]