# 기계적스위치

> 상위: [[전자회로설계]]

로봇 시스템의 전력 제어와 안전을 위한 릴레이 및 기계적 스위치 회로입니다.

## 🔄 릴레이 구동 회로

### 기본 릴레이 제어
```
MCU GPIO ─── 저항 ─── 트랜지스터 베이스
                        │
                    릴레이 코일
                        │
                      다이오드 (역전압 보호)
                        │
                      GND

릴레이 선택:
- 5V 릴레이: 일반적인 로직 제어용
- 12V/24V 릴레이: 고전력 부하 제어용
```

### Arduino 릴레이 제어
```cpp
// 단순 릴레이 모듈 제어
#define RELAY_PIN 7

void setup() {
    pinMode(RELAY_PIN, OUTPUT);
    digitalWrite(RELAY_PIN, LOW);  // 릴레이 OFF
}

void controlRelay(bool state) {
    digitalWrite(RELAY_PIN, state ? HIGH : LOW);
    delay(10);  // 바운싱 방지
}

// 모터 전원 제어 예시
void motorPowerControl(bool enable) {
    if(enable) {
        digitalWrite(RELAY_PIN, HIGH);  // 모터 전원 ON
        delay(100);  // 전원 안정화 대기
    } else {
        digitalWrite(RELAY_PIN, LOW);   // 모터 전원 OFF
    }
}
```
### 고전력 릴레이 제어 (STM32)
```cpp
// 컨택터 제어 (고전력 모터용)
void setupContactorControl() {
    // GPIO 출력 설정
    GPIO_InitTypeDef GPIO_InitStruct = {0};
    GPIO_InitStruct.Pin = GPIO_PIN_8;
    GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);
}

void controlMainContactor(bool enable) {
    if(enable) {
        // 프리차지 먼저 (서서히 전압 상승)
        HAL_GPIO_WritePin(PRECHARGE_GPIO_Port, PRECHARGE_Pin, GPIO_PIN_SET);
        HAL_Delay(500);  // 500ms 프리차지
        
        // 메인 컨택터 ON
        HAL_GPIO_WritePin(MAIN_CONTACTOR_GPIO_Port, MAIN_CONTACTOR_Pin, GPIO_PIN_SET);
        HAL_Delay(100);
        
        // 프리차지 OFF
        HAL_GPIO_WritePin(PRECHARGE_GPIO_Port, PRECHARGE_Pin, GPIO_PIN_RESET);
    } else {
        // 즉시 차단
        HAL_GPIO_WritePin(MAIN_CONTACTOR_GPIO_Port, MAIN_CONTACTOR_Pin, GPIO_PIN_RESET);
    }
}
```

## 🛡️ 안전 시스템

### Emergency Stop 회로
```cpp
// 비상정지 시스템 (ESP32)
#define ESTOP_BUTTON 34     // 비상정지 버튼 (풀다운)
#define SAFETY_RELAY 25     // 안전 릴레이 출력
#define MOTOR_ENABLE 26     // 모터 인에이블

volatile bool emergencyStop = false;

void IRAM_ATTR estopISR() {
    emergencyStop = true;
    digitalWrite(SAFETY_RELAY, LOW);    // 즉시 릴레이 차단
    digitalWrite(MOTOR_ENABLE, LOW);    // 모터 비활성화
}

void setup() {
    pinMode(ESTOP_BUTTON, INPUT_PULLUP);
    pinMode(SAFETY_RELAY, OUTPUT);
    pinMode(MOTOR_ENABLE, OUTPUT);
    
    attachInterrupt(digitalPinToInterrupt(ESTOP_BUTTON), estopISR, FALLING);
}

void checkSafetySystem() {
    if(emergencyStop) {
        Serial.println("EMERGENCY STOP ACTIVATED!");
        // 모든 위험 요소 차단
        shutdownAllSystems();
        
        // 리셋을 위해서는 수동 조치 필요
        while(digitalRead(ESTOP_BUTTON) == LOW) {
            delay(100);
        }
        emergencyStop = false;
    }
}
```
### 릴레이 선택 가이드
```
접점 용량에 따른 분류:
- 신호용: 1A 이하 (센서 신호 스위칭)
- 일반용: 10A 이하 (일반 부하)  
- 전력용: 30A 이상 (모터, 히터 등)

코일 전압:
- 5V: 로직 레벨 제어
- 12V: 자동차, 일반 산업용
- 24V: 산업용 표준

접점 형태:
- SPST: 단순 ON/OFF
- SPDT: 전환 스위치
- DPDT: 양방향 모터 제어
```

## 🔧 실무 적용 예시

### 로봇 전원 시퀀스 제어
```cpp
// 전원 투입 시퀀스
void powerUpSequence() {
    Serial.println("Starting power sequence...");
    
    // 1. 제어 전원 먼저
    digitalWrite(CONTROL_POWER_RELAY, HIGH);
    delay(100);
    
    // 2. 센서 전원
    digitalWrite(SENSOR_POWER_RELAY, HIGH);
    delay(200);
    
    // 3. 통신 모듈 전원
    digitalWrite(COMM_POWER_RELAY, HIGH);
    delay(300);
    
    // 4. 마지막에 모터 전원 (가장 큰 부하)
    digitalWrite(MOTOR_POWER_RELAY, HIGH);
    delay(500);
    
    Serial.println("Power sequence complete");
}

// 안전한 전원 차단 시퀀스
void powerDownSequence() {
    Serial.println("Starting shutdown sequence...");
    
    // 역순으로 차단
    digitalWrite(MOTOR_POWER_RELAY, LOW);
    delay(100);
    digitalWrite(COMM_POWER_RELAY, LOW);
    delay(100);
    digitalWrite(SENSOR_POWER_RELAY, LOW);
    delay(100);
    digitalWrite(CONTROL_POWER_RELAY, LOW);
    
    Serial.println("Shutdown complete");
}
```

### 릴레이 상태 모니터링
```cpp
// 릴레이 접점 상태 확인
bool checkRelayStatus(int feedbackPin) {
    // 릴레이 보조 접점으로 실제 상태 확인
    return digitalRead(feedbackPin) == HIGH;
}

void monitorRelayHealth() {
    static unsigned long lastCheck = 0;
    
    if(millis() - lastCheck > 1000) {  // 1초마다 체크
        if(!checkRelayStatus(MAIN_RELAY_FB)) {
            Serial.println("WARNING: Main relay failure!");
            emergencyShutdown();
        }
        lastCheck = millis();
    }
}
```

---

## 🔗 연결 문서
- 상위: [[전자회로설계]]
- 관련: [[전원시스템]], [[모터드라이버]]
- 응용: [[제어시스템]], [[실시간제어]], [[안전시스템]]