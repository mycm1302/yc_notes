# 멀티플렉서

> 상위: [[전자회로설계]]

다수의 센서를 제한된 ADC 채널로 순차적으로 읽거나, 신호 경로를 선택적으로 제어하는 멀티플렉서 회로 설계입니다.

## 🔄 멀티플렉서 기본 개념

### 동작 원리
- **다중 입력, 단일 출력**: N개 입력 중 1개를 선택하여 출력
- **선택 신호**: 2^n개 입력을 제어하려면 n개의 선택 핀 필요
- **순차 스캔**: 프로그램으로 모든 채널을 순서대로 읽기

### 주요 용도
- **ADC 채널 확장**: 8채널 ADC로 16-32개 센서 읽기
- **신호 라우팅**: 다중 센서 중 하나를 선택적으로 처리
- **테스트 포인트**: 디버깅용 신호 선택

## 🔌 아날로그 멀티플렉서

### CD4051 (8채널 아날로그 MUX)
```
핀 구성:
- 입력: 8개 아날로그 채널 (X0-X7)
- 출력: 1개 공통 출력 (X)
- 선택: 3개 디지털 제어 (A, B, C)
- 전원: VDD(3-15V), VSS(-7.5V), VEE(GND)

선택 로직:
A B C | 선택 채널
0 0 0 | X0
0 0 1 | X1
0 1 0 | X2
... 
1 1 1 | X7
```

### CD4067 (16채널 아날로그 MUX)
```
핀 구성:
- 입력: 16개 아날로그 채널 (Y0-Y15)
- 출력: 1개 공통 출력 (Z)
- 선택: 4개 디지털 제어 (S0-S3)
- 인에이블: EN (LOW에서 동작)

특징:
- 단일 전원 동작 가능 (VCC-GND)
- 온저항: 약 80Ω (5V 동작시)
- 대역폭: 40MHz (-3dB)
```

## ⚡ 실무 설계 예시

### 다중 로드셀 시스템
```cpp
// ESP32 + CD4067 + 16개 로드셀
#define MUX_S0 25
#define MUX_S1 26  
#define MUX_S2 27
#define MUX_S3 14
#define MUX_EN 12
#define MUX_OUT 32  // ADC 채널

void setupMux() {
    pinMode(MUX_S0, OUTPUT);
    pinMode(MUX_S1, OUTPUT);
    pinMode(MUX_S2, OUTPUT);
    pinMode(MUX_S3, OUTPUT);
    pinMode(MUX_EN, OUTPUT);
    
    digitalWrite(MUX_EN, LOW);  // 멀티플렉서 활성화
}

float readLoadCell(int channel) {
    // 채널 선택 (4bit)
    digitalWrite(MUX_S0, (channel >> 0) & 1);
    digitalWrite(MUX_S1, (channel >> 1) & 1);
    digitalWrite(MUX_S2, (channel >> 2) & 1);
    digitalWrite(MUX_S3, (channel >> 3) & 1);
    
    delayMicroseconds(50);  // 스위칭 안정화
    
    // 멀티 샘플링
    long sum = 0;
    for(int i = 0; i < 16; i++) {
        sum += analogRead(MUX_OUT);
        delayMicroseconds(100);
    }
    
    float voltage = (sum / 16.0) * 3.3 / 4095.0;
    return voltage;
}

void scanAllSensors() {
    for(int ch = 0; ch < 16; ch++) {
        float value = readLoadCell(ch);
        Serial.printf("채널 %d: %.3fV\n", ch, value);
    }
}
```

### 다중 온도센서 모니터링
```cpp
// 8채널 온도센서 (LM35) 시스템
// CD4051 + ESP32

float temperatures[8];

void readAllTemperatures() {
    for(int ch = 0; ch < 8; ch++) {
        selectChannel(ch);
        delay(10);  // 안정화 시간
        
        float voltage = analogRead(A0) * 5.0 / 1023.0;
        temperatures[ch] = voltage * 100.0;  // LM35: 10mV/°C
    }
}

void selectChannel(int channel) {
    digitalWrite(A_PIN, (channel >> 0) & 1);
    digitalWrite(B_PIN, (channel >> 1) & 1);  
    digitalWrite(C_PIN, (channel >> 2) & 1);
}
```

## 🔢 디지털 멀티플렉서

### 74HC4051 (8채널 디지털 MUX)
```
특징:
- CMOS 로직
- 5V 동작
- 3-state 출력
- 낮은 소비전력

용도:
- 디지털 신호 선택
- I2C/SPI 채널 확장
- 클럭 신호 라우팅
```

### I2C 멀티플렉서 (TCA9548A)
```cpp
// 8채널 I2C 멀티플렉서
// 주소 충돌 해결 및 채널 확장

#include <Wire.h>
#define TCA9548A_ADDR 0x70

void selectI2CChannel(uint8_t channel) {
    if(channel > 7) return;
    
    Wire.beginTransmission(TCA9548A_ADDR);
    Wire.write(1 << channel);  // 해당 채널만 활성화
    Wire.endTransmission();
}

// 동일 주소의 센서 8개 사용 가능
void readAllIMU() {
    for(int ch = 0; ch < 8; ch++) {
        selectI2CChannel(ch);
        
        // MPU6050 읽기 (모두 동일 주소 0x68)
        readMPU6050();
    }
}
```

## 📊 멀티플렉서 특성 고려사항

### 전기적 특성
```
온저항(Ron):
- CD4051: 80Ω (5V), 180Ω (3V)
- CD4067: 80Ω (5V)
- 높은 임피던스 센서에서 전압강하 주의

차단 누설전류:
- nA 단위로 매우 작음
- 고임피던스 회로에서도 무시 가능

대역폭:
- CD4051: 40MHz (-3dB)
- 고속 신호에는 부적합
```

### 크로스토크
```
인접 채널 간 신호 누설:
- -80dB (1kHz에서)
- 정밀 측정시 순차 읽기 간격 확보
- 차폐 및 그라운드 가드 적용
```

## 🛡️ 노이즈 대책

### 스위칭 노이즈 최소화
```cpp
// 스위칭 시 안정화 시간 확보
void switchChannel(int channel) {
    selectChannel(channel);
    delayMicroseconds(100);  // 스위칭 과도현상 대기
    
    // 첫 번째 읽기는 버리기 (charge injection)
    analogRead(MUX_OUT);
    delayMicroseconds(50);
    
    // 실제 측정값
    int value = analogRead(MUX_OUT);
}
```

### 전원 디커플링
```
멀티플렉서 전원:
- VCC, VEE 각각에 100nF + 10μF
- 아날로그 그라운드 분리
- 디지털 제어신호 격리

PCB 레이아웃:
- 아날로그 입력 채널들 간격 확보  
- 그라운드 플레인 연속성 유지
- 디지털 제어 신호와 아날로그 신호 분리
```

## 🔧 설계 가이드라인

### 채널 수 확장
```
32채널 이상 필요시:
1. 다중 멀티플렉서 계층 구조
2. I2C/SPI 제어 ADC 사용 (ADS1115 등)
3. 전용 데이터 수집 모듈

계층 구조 예시:
Level1: 4개 CD4067 (16ch × 4 = 64ch)
Level2: 1개 CD4052 (4채널 선택)
제어: ESP32 (6개 디지털 핀)
```

### 정확도 향상
```
오차 요인:
- 온저항에 의한 전압 강하
- 온도 계수
- 스위칭 과도현상

개선 방법:
- 버퍼 증폭기 사용
- 차동 측정 방식
- 온도 보상
- 다중 샘플링 평균화
```

## 🔗 관련 문서
- 상위: [[전자회로설계]]
- 관련: [[ADC]], [[센서인터페이스]]
- 이론: [[신호조절]], [[증폭회로]]
- 응용: [[상태추정]], [[환경인식]]

---

*멀티플렉서 선택 시 전기적 특성과 신호 무결성을 종합적으로 고려하시기 바랍니다.*